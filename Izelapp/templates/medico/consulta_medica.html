{% extends 'componentes/Base.html' %}
{% load static %}

{% block title %}
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/medico/consulta.css' %}">

<!-- jQuery y Select2 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="container">
    <h2>Consulta Médica - Paciente: {{ paciente.first_name }} {{ paciente.last_name }}</h2>

    <!-- Campo CSRF para acceso desde JS -->
    <form id="csrf-form" style="display: none;">
        {% csrf_token %}
    </form>

    <form action="{% url 'listar_consulta' paciente.id %}" method="get">
        <button type="submit" class="btn btn-outline-primary">
            Consultas anteriores del paciente
        </button>
    </form>

    <!-- Botones -->
    <div class="btn-group mb-3" role="group">
        <button class="btn btn-outline-primary" onclick="loadForm('consulta')">Consulta actual</button>
        <button class="btn btn-outline-primary" onclick="loadForm('dato_antropometrico')">Dato Antropométrico</button>
        <button class="btn btn-outline-primary" onclick="loadForm('certificado_incapacidad')">Certificado Incapacidad</button>
        <button class="btn btn-outline-primary" onclick="loadForm('orden_medica')">Orden Médica</button>
        <button class="btn btn-outline-primary" onclick="loadForm('receta_medica')">Receta Médica</button>
        <button class="btn btn-outline-primary" onclick="loadForm('perfil_paciente')">Perfil Paciente</button>
        <button class="btn btn-outline-primary" onclick="loadForm('antecedente')">Antecedente</button>
        <button class="btn btn-outline-primary" onclick="loadForm('dato_quirurgico')">Dato Quirúrgico</button>
        <button class="btn btn-outline-primary" onclick="loadForm('vacuna')">Vacuna</button>
    </div>

    <!-- Contenedor donde se cargan los formularios -->
    <div id="form-display" class="border rounded p-4 shadow-sm">
        <p>Selecciona una opción para comenzar.</p>
    </div>

    <!-- Botón para enviar todo -->
    <button type="submit" id="submit-button" class="btn btn-success mt-3">Finalizar consulta</button>
</div>

<script>
    const pacienteId = "{{ paciente.id }}";
    const medicoId = "{{ medico.id }}";
    const citaId = "{{ cita.id }}";

    function getCSRFToken() {
        return document.querySelector('#csrf-form input[name=csrfmiddlewaretoken]').value;
    }

    function loadForm(formName) {
        const container = document.getElementById('form-display');

        // Guardar el formulario actual antes de cambiar
        const currentForm = container.querySelector('form');
        if (currentForm) {
            const currentFormData = new FormData(currentForm);
            const currentFormName = currentForm.getAttribute('data-form-name');
            if (currentFormName) {
                const json = {};
                currentFormData.forEach((value, key) => {
                    json[key] = value;
                });
                sessionStorage.setItem(`form_${currentFormName}`, JSON.stringify(json));
            }
        }

        container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>';

        fetch(`/get-form/${formName}/?paciente_id=${pacienteId}`)
            .then(response => response.text())
            .then(html => {
                container.innerHTML = html;
                let form = container.querySelector("form");
                if (form) {
                    form.setAttribute('data-form-name', formName);

                    // ✅ Inicialización correcta de Select2
                    setTimeout(() => {
                        $(form).find('.select2').each(function () {
                            const $this = $(this);
                            if (!$this.hasClass("select2-hidden-accessible")) {
                                $this.select2({
                                    placeholder: $this.data('placeholder') || 'Seleccione una opción',
                                    allowClear: true,
                                    width: '100%'
                                });
                            }
                        });
                    }, 0);

                    // Agregar ID del paciente
                    let inputPaciente = document.createElement("input");
                    inputPaciente.type = "hidden";
                    inputPaciente.name = "paciente_id";
                    inputPaciente.value = pacienteId;
                    form.appendChild(inputPaciente);

                    // Agregar ID del médico
                    let inputMedico = document.createElement("input");
                    inputMedico.type = "hidden";
                    inputMedico.name = "medico_id";
                    inputMedico.value = medicoId;
                    form.appendChild(inputMedico);

                    // Cargar datos anteriores
                    const savedData = sessionStorage.getItem(`form_${formName}`);
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        for (let key in data) {
                            const input = form.querySelector(`[name="${key}"]`);
                            if (input) input.value = data[key];
                        }
                    }
                }
            })
            .catch(error => {
                console.error("Error al cargar el formulario:", error);
                container.innerHTML = '<p class="text-danger">No se pudo cargar el formulario.</p>';
            });
    }

    document.getElementById('submit-button').addEventListener('click', function () {
        if (!confirm("¿Estás seguro de que deseas finalizar la consulta? Esta acción no se puede deshacer.")) {
            return;
        }

        let forms = document.querySelectorAll('#form-display form');
        if (forms.length === 0) {
            alert("No hay formularios cargados.");
            return;
        }

        let formularioData = [];

        forms.forEach(form => {
            let formName = form.getAttribute('data-form-name');
            let formData = new FormData(form);
            let data = {};

            formData.forEach((value, key) => {
                data[key] = value;
            });

            formularioData.push({
                form_name: formName,
                data: data
            });
        });

        console.log("Datos enviados al backend:", formularioData);

        fetch('/submit-all/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                paciente_id: pacienteId,
                medico_id: medicoId,
                cita_id: citaId,
                formularios: formularioData
            })
        })
        .then(response => response.json())
        .then(json => {
            if (json.redirect_url) {
                window.location.href = json.redirect_url;
            } else if (json.message) {
                alert(json.message);
            } else if (json.error) {
                alert("Error: " + json.error);
            }
        })
        .catch(error => {
            console.error("Error en el envío:", error);
            alert("Ocurrió un error al enviar los formularios.");
        });
    });
</script>
{% endblock %}
