{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h2>Consulta M√©dica - Paciente: {{ paciente.username }}</h2>

    <!-- Campo CSRF para acceso desde JS -->
    <form id="csrf-form" style="display: none;">
        {% csrf_token %}
    </form>

    <!-- Botones -->
    <div class="btn-group mb-3" role="group">
        <button class="btn btn-outline-primary" onclick="loadForm('consulta')">Consulta</button>
        <button class="btn btn-outline-primary" onclick="loadForm('dato_antropometrico')">Dato Antropom√©trico</button>
        <button class="btn btn-outline-primary" onclick="loadForm('certificado_incapacidad')">Certificado Incapacidad</button>
        <button class="btn btn-outline-primary" onclick="loadForm('orden_medica')">Orden M√©dica</button>
        <button class="btn btn-outline-primary" onclick="loadForm('receta_medica')">Receta M√©dica</button>
        <button class="btn btn-outline-primary" onclick="loadForm('perfil_paciente')">Perfil Paciente</button>
        <button class="btn btn-outline-primary" onclick="loadForm('antecedente')">Antecedente</button>
        <button class="btn btn-outline-primary" onclick="loadForm('dato_quirurgico')">Dato Quir√∫rgico</button>
        <button class="btn btn-outline-primary" onclick="loadForm('vacuna')">Vacuna</button>
    </div>

    <!-- Contenedor donde se cargan los formularios -->
    <div id="form-display" class="border rounded p-4 shadow-sm">
        <p>Selecciona una opci√≥n para comenzar.</p>
    </div>

    <!-- Bot√≥n para enviar todo -->
    <button type="submit" id="submit-button" class="btn btn-success mt-3">Finalizar consulta</button>
</div>

<script>
    const pacienteId = "{{ paciente.id }}";
    const medicoId = "{{ medico.id }}"; 
    
    // Funci√≥n para obtener el CSRF token del formulario oculto
    function getCSRFToken() {
        return document.querySelector('#csrf-form input[name=csrfmiddlewaretoken]').value;
    }

    function loadForm(formName) {
    const container = document.getElementById('form-display');

    // üëâ Guardar el formulario actual antes de cambiar (si existe)
    const currentForm = container.querySelector('form');
    if (currentForm) {
        const currentFormData = new FormData(currentForm);
        const currentFormName = currentForm.getAttribute('data-form-name');
        if (currentFormName) {
            const json = {};
            currentFormData.forEach((value, key) => {
                json[key] = value;
            });
            sessionStorage.setItem(`form_${currentFormName}`, JSON.stringify(json));
        }
    }

    container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>';

    fetch(`/get-form/${formName}/?paciente_id=${pacienteId}`)
        .then(response => response.text())
        .then(html => {
            container.innerHTML = html;
            let form = container.querySelector("form");
            if (form) {
                form.setAttribute('data-form-name', formName);

                $(form).find('.select2').select2({
                    placeholder: function() {
                        return $(this).data('placeholder');
                    },
                    allowClear: true
                });

                // Agregar ID del paciente al formulario
                let inputPaciente = document.createElement("input");
                inputPaciente.type = "hidden";
                inputPaciente.name = "paciente_id";
                inputPaciente.value = pacienteId;
                form.appendChild(inputPaciente);

                // Agregar ID del m√©dico autom√°ticamente
                let inputMedico = document.createElement("input");
                inputMedico.type = "hidden";
                inputMedico.name = "medico_id";
                inputMedico.value = medicoId;
                form.appendChild(inputMedico);

                // Cargar datos previos si los hay
                const savedData = sessionStorage.getItem(`form_${formName}`);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    for (let key in data) {
                        const input = form.querySelector(`[name="${key}"]`);
                        if (input) input.value = data[key];
                    }
                }
            }
        })
        .catch(error => {
            console.error("Error al cargar el formulario:", error);
            container.innerHTML = '<p class="text-danger">No se pudo cargar el formulario.</p>';
        });
    }

    document.getElementById('submit-button').addEventListener('click', function() {
    let forms = document.querySelectorAll('#form-display form');
    if (forms.length === 0) {
        alert("No hay formularios cargados.");
        return;
    }

    let formularioData = [];

    forms.forEach(form => {
        let formName = form.getAttribute('data-form-name');
        let formData = new FormData(form);
        let data = {};
        
        formData.forEach((value, key) => {
            data[key] = value;
        });

        formularioData.push({
            form_name: formName,
            data: data
        });
    });

    console.log("Datos enviados al backend:", formularioData);  // Esto va a mostrar los datos en la consola

    // Aqu√≠ se pasa el formulario con todos los datos
    fetch('/submit-all/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            paciente_id: pacienteId,
            medico_id: medicoId,
            formularios: formularioData
        })
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message || 'Datos enviados con √©xito');
    })
    .catch(err => {
        console.error(err);
        alert('Error al enviar los datos');
    });
});

</script>
{% endblock %}
